<!DOCTYPE html>
<html>
	<head>
		<title>KAFKAESQUE | Home</title>
		<link rel="stylesheet" href="../style.css">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="icon" type="image/png" href="/img/Logo_maroon.png">
	</head>
		
	<body>
		<nav>
			<div class="logo" onclick="window.location.href='/'">
			  <img class="nav-img" src="/img/Logo_white.png" alt="KAFKAESQUE Logo">
			  <span class="nav-logoname">KAFKAESQUE</span>
			</div>

			<div style="width:50%;">
				<input type="text" class="nav-search" id="searchInput" placeholder="Search...">
				<img class="search-icon" src="/img/Search.png" onclick="performSearch()">
			</div>
		  
			<div class="nav-user" style="display: flex">
				<img class="search-icon" src="/img/Search.png" style="float:right;" onclick="window.location.href='/html/search.html';">
				<div class="nav-profile" onclick="navigateToUserProfile()">
					<span class="nav-profilename"></span>
					<img class="nav-img" id="nav-user" src="/img/profiles/default.jpg" alt="Profile Picture" style="margin-right: 0; padding-right: 0;">
				</div>
			</div>	
		</nav>	
		
		<main class="main-padding">
			<section class="col-trending">
				<span>Trending Games</span><br>
				
				<div class="trending-list">
					<a href="https://www.youtube.com/watch?v=1INU3FOJsTw&ab_channel=StreetFighter"><img src="../img/trending/1.png" class="ind-game"></a><br>
					<a href="https://www.youtube.com/watch?v=XPYqvSRWkx4&ab_channel=Honkai%3AStarRail"><img src="../img/trending/2.png" class="ind-game"></a><br>
					<a href="https://www.youtube.com/watch?v=hCgiwsIUI4g&ab_channel=GameSpot"><img src="../img/trending/3.png" class="ind-game"></a><br>
					<a href="https://www.youtube.com/watch?v=kJawWyRUOBM&ab_channel=GameSpot"><img src="../img/trending/4.png" class="ind-game"></a><br>
					<a href="https://www.youtube.com/watch?v=_ckLOyVEVVs&ab_channel=GameSpot"><img src="../img/trending/5.png" class="ind-game"></a><br>
				</div>
			</section>
			
			<section class="col-main">	
				<button type="submit" class="back-btn" onclick="window.location.href='/';"><img src="/img/back.png" style="width:30px;"></button><br>

				<span class="search-title" wrap="soft">Search for ...</span><br><br><hr><br><br>
						
				<div class="postContainer">
					<div class="search-result"><img src="../img/pepe jr support.png"></div>	
				</div>
			</section>	
			
			<section class="col-cat">
				<span class="cat-title">Categories</span><br>
				<span class="cat-ind">Action</span><br>
				<span class="cat-ind">Action-Adventure</span><br>
				<span class="cat-ind">Adventure</span><br>
				<span class="cat-ind">Board Games</span><br>
				<span class="cat-ind">Gacha</span><br>
				<span class="cat-ind">MMO</span><br>
				<span class="cat-ind">Platformer</span><br>
				<span class="cat-ind">Puzzle</span><br>	
				<span class="cat-ind">Role-Playing</span><br>
				<span class="cat-ind">Simulation</span><br>
				<span class="cat-ind">Strategy</span><br>	
			</section>
		</main>
		
		<script>
			let loggedInUsername = null;
			let upvotedPosts = [];
			let downvotedPosts = [];

			/* ------------------------------ NAVIGATION ------------------------------ */
			function navigateToUserProfile() {
				if (loggedInUsername) {
					const userProfileUrl = `/html/profile.html?username=${encodeURIComponent(loggedInUsername)}`;
					window.location.href = userProfileUrl;
				} else {
					console.error('User is not logged in. Unable to redirect to the profile.');
				}
			}

			/* ------------------------------ FETCH USER DETAILS ------------------------------ */
			async function fetchUserDetails() {
				try {
				const profileResponse = await fetch('/api/profile');
				const profileData = await profileResponse.json();

				if (profileResponse.status === 200) {
					const usernameElement = document.querySelector('.nav-profilename');
					const profilePictureElement = document.querySelector('#nav-user');

					loggedInUsername = profileData.data.username;

					usernameElement.textContent = profileData.data.username;
					profilePictureElement.src = profileData.data.profilepicture;

					// Assuming the user data includes upvotedPosts and downvotedPosts arrays
					upvotedPosts = profileData.data.upvotedPosts;
					downvotedPosts = profileData.data.downvotedPosts;
				} else {
					console.log('User not authenticated or user details not found');
				}
				} catch (error) {
				console.error('Error fetching user details:', error);
				}
			}

			function searchTitleUpdate() {
				const searchInput = document.querySelector('#searchInput');
				const searchTitle = document.querySelector('.search-title');

				if (searchInput.value === '') {
					searchTitle.textContent = 'Search for ...';
				} else {
					searchTitle.textContent = "Searching for \"" + searchInput.value + "\"";
				}
			}

			async function updatePostViews(postId) {
				try {
					await fetch(`/api/views/${postId}`, {
						method: 'PATCH',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({}),
					});
				} catch (error) {
					console.error('Error updating post views:', error);
				}
			}

			function attachTitleClickListeners() {
					const postTitles = document.querySelectorAll('.ind-title');

					postTitles.forEach((titleElement) => {
						console.log(titleElement);
						titleElement.addEventListener('click', (event) => {
						event.preventDefault();
						const postElement = titleElement.closest('.ind-post');
						const postId = postElement.dataset.postId;
						updatePostViews(postId);
						navigateToPost(postId);
					});
				});
			}

			// Function to handle navigation to a single post
			function navigateToPost(postId) {
				const postUrl = `/html/post.html?postId=${encodeURIComponent(postId)}`;
				window.location.href = postUrl;
			}
				
			function navigateToProfiles(username) {
				const userProfileUrl = `/html/profile.html?username=${encodeURIComponent(username)}`;
				window.location.href = userProfileUrl;
			}

			// Function to add click event listeners to the post-username elements
			function attachUsernameClickListeners() {
				const postUsernames = document.querySelectorAll('.post-username');

				postUsernames.forEach((usernameElement) => {
					usernameElement.addEventListener('click', (event) => {
						event.preventDefault();
						const username = event.target.textContent;
						navigateToProfiles(username);
					});
				});
			}

			function getSnippet(text) {
				const MAX_SNIPPET_LENGTH = 100;
				if (text.length > MAX_SNIPPET_LENGTH) {
					return text.substring(0, MAX_SNIPPET_LENGTH) + '...';
				}
				return text;
			}

			function displaySearchResults(searchQuery) {
				const searchResultDiv = document.querySelector('.postContainer');
				searchResultDiv.innerHTML = '';

				if (searchQuery.trim() === '') {
					searchResultDiv.innerHTML = `
						<div class="search-result">
							<img src="../img/pepe jr support.png"><br><br>
							<span>Please enter a search query</span>
						</div>
					`;
					return;
				}

				fetch(`/api/results/${searchQuery}`)
				.then(response => response.json())
				.then(data => {
					if (data.posts.length === 0 && data.accounts.length === 0) {
						searchResultDiv.innerHTML = `
							<div class="search-result">
								<img src="../img/pepe jr support.png"><br><br>
								<span>No results found :(</span>
							</div>
						`;
					} else {
					data.posts.forEach(post => {
						const postElement = createPostElement(post);
						searchResultDiv.appendChild(postElement);
						attachTitleClickListeners();
						attachUsernameClickListeners();
					});

					data.accounts.forEach(account => {
						const accountElement = createAccountElement(account);
						searchResultDiv.appendChild(accountElement);
						attachUsernameClickListeners();
					});

					}
				})
				.catch(error => {
					console.error('Error fetching search results:', error);
					searchResultDiv.innerHTML = '<span>Error fetching search results</span>';
				});
			}

			function createPostElement(post) {
				const postDetailsContainer = document.createElement('div');
				postDetailsContainer.classList.add('ind-post');
				postDetailsContainer.dataset.postId = post._id;

				let tagsHTML = '';
				if (post.tags !== null) {
					const tagsArray = post.tags.map(tag => `#${tag}`);
					tagsHTML = tagsArray.join(' ');
				}

				const userUpvoted = upvotedPosts.includes(post._id);
				const userDownvoted = downvotedPosts.includes(post._id);

				postDetailsContainer.innerHTML = `
				${post.image ? `
					<div class="ind-imgcontainer">
					<img class="ind-img" src="${post.image}">
					</div>
				` : ''}

				<section style="width: 60%;">
					<h2 class="ind-title">${post.title}</h2>
					<h4>${post.tags}</h4>
					<span class="text-preview">${getSnippet(post.description)}</span><br>
					<div class="post-inter">
						<img src="/img/posts/views.png" style="width: 0.8rem; vertical-align: middle;">
						<span style="vertical-align: middle;">${post.views}</span>
						<img src="/img/posts/comments.png" style="width: 0.7rem; vertical-align: middle;">
						<span style="vertical-align: middle;">${post.commentsCount}</span>
						<span style="vertical-align: middle;">&nbsp â€¢ &nbsp ${new Date(post.createdAt).toLocaleDateString()}</span>
					</div><br>
					<span class="post-username">${post.username}</span>
				</section>

				<div class="vote-container">
					<span class="upvote-count">${post.upvotes}</span>
					<button class="vote-button upvote ${userUpvoted ? 'voted' : ''}">
						<img class="upvote-image" src="/img/posts/upvote.png" alt="Upvote">
					</button>
					<button class="vote-button downvote ${userDownvoted ? 'voted' : ''}">
						<img class="downvote-image" src="/img/posts/downvote.png" alt="Downvote">
					</button>
					<span class="downvote-count">${post.downvotes}</span>
				</div>
				`;

				attachVoteEventListeners(postDetailsContainer);
				
				return postDetailsContainer;
			}

			function createAccountElement(account) {
				const accountElement = document.createElement('div');
				accountElement.classList.add('ind-post');

				accountElement.innerHTML = `
					<div class="ind-imgcontainer">
					<img class="ind-img" src="${account.profilepicture}">
					</div>
					<section style="width: 75%;">
						<h2>${account.displayname}</h2>
						<h4>${account.location}</h4>
						<span class="text-preview">${account.bio}</span><br>
						<span class="post-username">${account.username}</span>
					</section>
				`;

				return accountElement;
			}

			function attachVoteEventListeners(voteContainer) {
				const upvoteButton = voteContainer.querySelector(".upvote");
				const downvoteButton = voteContainer.querySelector(".downvote");
				const upvoteCount = voteContainer.querySelector(".upvote-count");
				const downvoteCount = voteContainer.querySelector(".downvote-count");

				let upvoteCounter = parseInt(upvoteCount.textContent);
				let downvoteCounter = parseInt(downvoteCount.textContent);

				// Function to find the postId from the voteContainer
				function findPostId() {
					const postContainer = voteContainer.closest(".ind-post");
					if (postContainer) {
					return postContainer.dataset.postId;
					}
					return null;
				}

				upvoteButton.addEventListener("click", async () => {
					// Alert the user to login if they want to vote
					if (loggedInUsername === null) {
						alert("You must be logged in to vote!");
						return;
					}

					try {
						const postId = findPostId(); // Get the postId from the dataset attribute

						if (upvoteButton.classList.contains("voted")) {
							// User has already upvoted, decrement the counter and remove the vote
							upvoteCounter--;
							upvoteButton.classList.remove("voted");
							localStorage.removeItem(`${postId}_vote`);

							// Send an HTTP PATCH request to remove the upvote from the server
							await fetch(`/api/posts/${postId}/vote`, {
							method: "PATCH",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({ voteType: "remove_upvote" }),
							});
						} else {
							// User is upvoting, increment the counter and set the vote
							upvoteCounter++;
							upvoteButton.classList.add("voted");
							localStorage.setItem(`${postId}_vote`, "upvote");
							localStorage.removeItem(`${postId}_downvote`);

							// If downvoteButton is active, decrease its counter and remove the downvote
							if (downvoteButton.classList.contains("voted")) {
								downvoteCounter--;
								downvoteButton.classList.remove("voted");

								await fetch(`/api/posts/${postId}/vote`, {
									method: "PATCH",
									headers: {
									"Content-Type": "application/json",
									},
									body: JSON.stringify({ voteType: "remove_downvote" }),
								});
							}

							// Send an HTTP PATCH request to remove the downvote and add an upvote to the server
							await fetch(`/api/posts/${postId}/vote`, {
								method: "PATCH",
								headers: {
								"Content-Type": "application/json",
								},
								body: JSON.stringify({ voteType: "upvote" }),
							});
						}

						// Update the vote count elements
						upvoteCount.textContent = upvoteCounter.toString();
						downvoteCount.textContent = downvoteCounter.toString();
					} catch (error) {
					console.error("Error upvoting post:", error);
					}
				});

				downvoteButton.addEventListener("click", async () => {
					if (loggedInUsername === null) {
						alert("You must be logged in to vote!");
						return;
					}

					try {
					const postId = findPostId(); // Get the postId from the dataset attribute

					if (downvoteButton.classList.contains("voted")) {
						// User has already downvoted, decrement the counter and remove the vote
						downvoteCounter--;
						downvoteButton.classList.remove("voted");
						localStorage.removeItem(`${postId}_vote`);
						// Send an HTTP PATCH request to remove the downvote from the server
						await fetch(`/api/posts/${postId}/vote`, {
						method: "PATCH",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({ voteType: "remove_downvote" }),
						});
					} else {
						// User is downvoting, increment the counter and set the vote
						downvoteCounter++;
						downvoteButton.classList.add("voted");
						localStorage.setItem(`${postId}_vote`, "downvote");
						localStorage.removeItem(`${postId}_upvote`);

						// If upvoteButton is active, decrease its counter and remove the upvote
						if (upvoteButton.classList.contains("voted")) {
						upvoteCounter--;
						upvoteButton.classList.remove("voted");

						await fetch(`/api/posts/${postId}/vote`, {
							method: "PATCH",
							headers: {
							"Content-Type": "application/json",
							},
							body: JSON.stringify({ voteType: "remove_upvote" }),
						});
						}

						// Send an HTTP PATCH request to remove the upvote and add a downvote to the server
						await fetch(`/api/posts/${postId}/vote`, {
							method: "PATCH",
							headers: {
							"Content-Type": "application/json",
							},
							body: JSON.stringify({ voteType: "downvote" }),
						});
					}

					// Update the vote count elements
					upvoteCount.textContent = upvoteCounter.toString();
					downvoteCount.textContent = downvoteCounter.toString();
					} catch (error) {
					console.error("Error downvoting post:", error);
					}
				});

				// Check the local storage for user vote when attaching event listeners
				const postId = findPostId();
				const userVote = localStorage.getItem(`${postId}_vote`);

				if (userVote === "upvote") {
					upvoteButton.classList.add("voted");
				} else if (userVote === "downvote") {
					downvoteButton.classList.add("voted");
				}
			}

			function performSearch() {
				const searchInput = document.getElementById('searchInput').value;
				displaySearchResults(searchInput);
				searchTitleUpdate();
			}

			document.addEventListener('DOMContentLoaded', () => {
				fetchUserDetails();
			});
		</script>
	</body>
</html>